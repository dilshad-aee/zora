<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <!-- PWA / Theme -->
    <meta name="theme-color" content="#121212">
    <meta name="background-color" content="#121212">
    <meta name="description" content="Zora - Download and play music from YouTube. Your personal music library.">
    <meta name="application-name" content="Zora">

    <!-- Apple / iOS PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Zora">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/icons/icon-192x192.png') }}">
    <link rel="apple-touch-icon" sizes="152x152" href="{{ url_for('static', filename='images/icons/icon-152x152.png') }}">
    <link rel="apple-touch-icon" sizes="144x144" href="{{ url_for('static', filename='images/icons/icon-144x144.png') }}">
    <link rel="apple-touch-icon" sizes="128x128" href="{{ url_for('static', filename='images/icons/icon-128x128.png') }}">
    <link rel="apple-touch-icon" sizes="96x96"  href="{{ url_for('static', filename='images/icons/icon-96x96.png') }}">
    <link rel="apple-touch-icon" sizes="72x72"  href="{{ url_for('static', filename='images/icons/icon-72x72.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='images/icons/icon-192x192.png') }}">
    <meta name="apple-mobile-web-app-splash-screen" content="{{ url_for('static', filename='images/icons/icon-512x512.png') }}">

    <!-- Microsoft / Windows -->
    <meta name="msapplication-TileColor" content="#121212">
    <meta name="msapplication-TileImage" content="{{ url_for('static', filename='images/icons/icon-144x144.png') }}">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- PWA Manifest -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='images/icons/icon-192x192.png') }}">
    <link rel="icon" type="image/png" sizes="32x32"   href="{{ url_for('static', filename='logo.png') }}">

    <title>Zora - YouTube Music Downloader</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/desktop.css') }}">
</head>
<body>
    <div class="app">
        <!-- Mobile Header -->
        <header class="mobile-header" id="mobileHeader">
            <button class="mobile-header__menu" id="menuToggle" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <div class="mobile-header__brand">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="Zora" class="mobile-header__logo">
                <span>Zora</span>
            </div>
            <button class="mobile-header__action mobile-header__action--settings" data-role="admin" onclick="openSettings()">
                <i class="fas fa-cog"></i>
            </button>
        </header>

        <!-- Sidebar Overlay (Mobile) -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
        
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar__brand">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="Zora" class="sidebar__logo">
                <span>Zora</span>
            </div>
            
            <nav class="sidebar__nav">
                <a class="nav-link" data-view="download" data-role="admin" onclick="showView('download'); closeSidebar();">
                    <i class="fas fa-download"></i>
                    <span>Download</span>
                </a>
                <a class="nav-link active" data-view="library" onclick="showView('library'); closeSidebar();">
                    <i class="fas fa-music"></i>
                    <span>My Music</span>
                </a>
                <a class="nav-link" data-view="playlists" onclick="showView('playlists'); closeSidebar();">
                    <i class="fas fa-list-ul"></i>
                    <span>Playlists</span>
                </a>
                <a class="nav-link" data-view="playlist-downloads" data-role="admin" onclick="showView('playlist-downloads'); closeSidebar();">
                    <i class="fas fa-download"></i>
                    <span>Playlist Downloads</span>
                </a>
                <a class="nav-link" data-view="admin" data-role="admin" onclick="showView('admin'); closeSidebar();">
                    <i class="fas fa-shield-alt"></i>
                    <span>Admin</span>
                </a>
                <a class="nav-link" data-view="profile" onclick="showView('profile'); closeSidebar();">
                    <i class="fas fa-user-circle"></i>
                    <span>Profile</span>
                </a>
            </nav>
            
            <div class="sidebar__footer">
                <button class="sidebar__btn sidebar__btn--settings" data-role="admin" onclick="openSettings(); closeSidebar();">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </button>
                <div id="sidebarUserInfo"></div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main" id="mainContent">

            <!-- LOGIN VIEW -->
            <div class="view hidden" id="loginView">
                <div class="auth-container">
                    <div class="auth-card">
                        <div class="auth-card__brand">
                            <img src="{{ url_for('static', filename='logo.png') }}" alt="Zora" class="auth-card__logo">
                            <h1>Welcome to Zora</h1>
                            <p>Sign in to your account</p>
                        </div>
                        <form class="auth-form" onsubmit="handleLogin(event)">
                            <div class="form-group">
                                <label for="loginEmail">Email</label>
                                <input type="email" id="loginEmail" class="form-input" placeholder="you@example.com" required autocomplete="email">
                            </div>
                            <div class="form-group">
                                <label for="loginPassword">Password</label>
                                <input type="password" id="loginPassword" class="form-input" placeholder="••••••••" required autocomplete="current-password">
                            </div>
                            <button type="submit" class="btn btn--primary btn--full" id="loginBtn">
                                <i class="fas fa-sign-in-alt"></i> Sign In
                            </button>
                        </form>
                        <p class="auth-card__forgot">
                            <a href="#" onclick="switchAuthTab('forgot-password'); return false;">Forgot password?</a>
                        </p>
                        <div class="auth-divider"><span>or</span></div>
                        <a href="/api/auth/google/start" class="btn btn--google btn--full">
                            <svg class="google-icon" viewBox="0 0 24 24" width="18" height="18">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            Continue with Google
                        </a>
                        <p class="auth-card__switch">
                            Don't have an account? <a href="#" onclick="switchAuthTab('signup'); return false;">Create one</a>
                        </p>
                    </div>
                </div>
            </div>

            <!-- SIGNUP VIEW -->
            <div class="view hidden" id="signupView">
                <div class="auth-container">
                    <div class="auth-card">
                        <div class="auth-card__brand">
                            <img src="{{ url_for('static', filename='logo.png') }}" alt="Zora" class="auth-card__logo">
                            <h1>Create Account</h1>
                            <p>Join Zora to start listening</p>
                        </div>
                        <form class="auth-form" onsubmit="handleSignup(event)">
                            <div class="form-group">
                                <label for="signupName">Name</label>
                                <input type="text" id="signupName" class="form-input" placeholder="Your name" required autocomplete="name">
                            </div>
                            <div class="form-group">
                                <label for="signupEmail">Email</label>
                                <input type="email" id="signupEmail" class="form-input" placeholder="you@example.com" required autocomplete="email">
                            </div>
                            <div class="form-group">
                                <label for="signupPassword">Password</label>
                                <input type="password" id="signupPassword" class="form-input" placeholder="Min 8 characters" required autocomplete="new-password" minlength="8">
                            </div>
                            <div class="form-group">
                                <label for="signupConfirmPassword">Confirm Password</label>
                                <input type="password" id="signupConfirmPassword" class="form-input" placeholder="••••••••" required autocomplete="new-password">
                            </div>
                            <button type="submit" class="btn btn--primary btn--full" id="signupBtn">
                                <i class="fas fa-user-plus"></i> Create Account
                            </button>
                        </form>
                        <div class="auth-divider"><span>or</span></div>
                        <a href="/api/auth/google/start" class="btn btn--google btn--full">
                            <svg class="google-icon" viewBox="0 0 24 24" width="18" height="18">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            Continue with Google
                        </a>
                        <p class="auth-card__switch">
                            Already have an account? <a href="#" onclick="switchAuthTab('login'); return false;">Sign in</a>
                        </p>
                    </div>
                </div>
            </div>
            <!-- FORGOT PASSWORD VIEW -->
            <div class="view hidden" id="forgotPasswordView">
                <div class="auth-container">
                    <div class="auth-card">
                        <div class="auth-card__brand">
                            <img src="{{ url_for('static', filename='logo.png') }}" alt="Zora" class="auth-card__logo">
                            <h1>Reset Password</h1>
                            <p>Enter your email to receive a reset link</p>
                        </div>
                        <form class="auth-form" onsubmit="handleForgotPassword(event)">
                            <div class="form-group">
                                <label for="forgotEmail">Email</label>
                                <input type="email" id="forgotEmail" class="form-input" placeholder="you@example.com" required autocomplete="email">
                            </div>
                            <button type="submit" class="btn btn--primary btn--full" id="forgotPasswordBtn">
                                <i class="fas fa-paper-plane"></i> Send Reset Link
                            </button>
                        </form>
                        <p class="auth-card__switch">
                            Remember your password? <a href="#" onclick="switchAuthTab('login'); return false;">Sign in</a>
                        </p>
                    </div>
                </div>
            </div>

            <!-- RESET PASSWORD VIEW -->
            <div class="view hidden" id="resetPasswordView">
                <div class="auth-container">
                    <div class="auth-card">
                        <div class="auth-card__brand">
                            <img src="{{ url_for('static', filename='logo.png') }}" alt="Zora" class="auth-card__logo">
                            <h1>Set New Password</h1>
                            <p>Choose a strong new password</p>
                        </div>
                        <form class="auth-form" onsubmit="handleResetPassword(event)">
                            <div class="form-group">
                                <label for="resetNewPassword">New Password</label>
                                <input type="password" id="resetNewPassword" class="form-input" placeholder="Min 8 characters" required autocomplete="new-password" minlength="8">
                            </div>
                            <div class="form-group">
                                <label for="resetConfirmPassword">Confirm Password</label>
                                <input type="password" id="resetConfirmPassword" class="form-input" placeholder="••••••••" required autocomplete="new-password">
                            </div>
                            <button type="submit" class="btn btn--primary btn--full" id="resetPasswordBtn">
                                <i class="fas fa-key"></i> Reset Password
                            </button>
                        </form>
                        <p class="auth-card__switch">
                            <a href="#" onclick="switchAuthTab('login'); return false;">Back to sign in</a>
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- DOWNLOAD VIEW -->
            <div class="view hidden" id="downloadView">
                <div class="hero">
                    <h1 class="hero__title">
                        <img src="{{ url_for('static', filename='logo.png') }}" alt="" class="hero__logo">
                        <span class="hero__title-text">Download Music with Zora</span>
                    </h1>
                    <p class="hero__subtitle">Paste a YouTube link or search for your favorite songs</p>
                    
                    <!-- Search Box -->
                    <div class="search-box">
                        <div class="search-box__tabs">
                            <button class="tab active" id="tabUrl" onclick="switchTab('url')">
                                <i class="fas fa-link"></i>
                                <span class="tab__text">Paste URL</span>
                            </button>
                            <button class="tab" id="tabPlaylist" onclick="switchTab('playlist')">
                                <i class="fas fa-list"></i>
                                <span class="tab__text">Playlist</span>
                            </button>
                            <button class="tab" id="tabSearch" onclick="switchTab('search')">
                                <i class="fas fa-search"></i>
                                <span class="tab__text">Search</span>
                            </button>
                        </div>
                        
                        <div class="search-box__input-wrapper">
                            <input type="text" 
                                   id="mainInput" 
                                   class="search-input"
                                   placeholder="Paste YouTube or YouTube Music URL here..."
                                   autocomplete="off"
                                   autocorrect="off"
                                   autocapitalize="off"
                                   spellcheck="false"
                                   enterkeyhint="go">
                            <button class="search-btn" id="mainBtn" onclick="handleMainAction()">
                                <i class="fas fa-arrow-right"></i>
                                <span class="search-btn__text">Analyze</span>
                            </button>
                        </div>
                        
                        <p class="search-hint" id="searchHint">
                            <i class="fas fa-info-circle"></i>
                            Supports: youtube.com, youtu.be, music.youtube.com
                        </p>
                    </div>
                </div>
                
                <!-- Search Results -->
                <div class="results-section hidden" id="resultsSection">
                    <h2 class="section-title">
                        <i class="fas fa-search"></i> Search Results
                        <button class="clear-btn" onclick="clearResults()">Clear</button>
                    </h2>
                    <div class="results-grid" id="resultsGrid"></div>
                </div>
                
                <!-- Ready to Download Card -->
                <div class="download-ready hidden" id="downloadReady">
                    <div class="download-card">
                        <img id="previewThumb" src="{{ url_for('static', filename='images/default-album.png') }}" alt="" class="download-card__image" onerror="this.onerror=null;this.src='/static/images/default-album.png';">
                        <div class="download-card__info">
                            <div class="download-card__eyebrow">
                                <span class="download-card__badge" id="previewTypeBadge">Single Track</span>
                            </div>
                            <h3 id="previewTitle" class="download-card__title">Song Title</h3>
                            <p id="previewArtist" class="download-card__artist">Artist Name</p>
                            <div class="download-card__meta">
                                <span id="previewDuration"><i class="fas fa-clock"></i> 0:00</span>
                                <span id="previewViews"><i class="fas fa-eye"></i> 0 views</span>
                            </div>
                            
                            <!-- Duplicate Warning -->
                            <div class="warning-banner hidden" id="duplicateWarning">
                                <i class="fas fa-exclamation-triangle"></i>
                                This song is already in your library
                            </div>
                        </div>
                        
                        <div class="download-card__actions">
                            <div class="download-card__panel">
                                <div class="format-picker">
                                    <label>Format</label>
                                    <select id="formatSelect" class="format-select">
                                        <option value="m4a" selected>M4A (iPhone)</option>
                                        <option value="mp3">MP3 (Universal)</option>
                                        <option value="flac">FLAC (Lossless)</option>
                                    </select>
                                </div>
                                <p class="download-card__format-note">Recommended for mobile: M4A or MP3.</p>
                            </div>

                            <div class="download-card__button-group">
                                <button class="btn btn--primary download-card__download-btn" id="downloadNowBtn" onclick="startDownload()">
                                    <i class="fas fa-download"></i>
                                    <span>Download Now</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Playlist Preview Section -->
                <div class="playlist-preview hidden" id="playlistPreview">
                    <h2 class="section-title">
                        <i class="fas fa-list"></i> 
                        <span id="playlistTitle">Playlist</span>
                        <span id="playlistCount" class="text-muted">(0 songs)</span>
                    </h2>
                    
                    <div class="playlist-create-row">
                        <label class="playlist-create-option" for="autoCreatePlaylistCheckbox">
                            <input type="checkbox" id="autoCreatePlaylistCheckbox">
                            <span class="playlist-create-option__text">
                                <span class="playlist-create-option__title">Add this as a playlist</span>
                                <span class="playlist-create-option__desc">Create a new playlist and auto-add downloaded or skipped duplicate songs.</span>
                            </span>
                        </label>
                    </div>

                    <div class="playlist-controls">
                        <button class="btn btn--secondary btn--small" onclick="selectAllSongs()">
                            <i class="fas fa-check-square"></i>
                            <span class="btn-text">Select All</span>
                        </button>
                        <button class="btn btn--secondary btn--small" onclick="deselectAllSongs()">
                            <i class="fas fa-square"></i>
                            <span class="btn-text">Deselect All</span>
                        </button>
                        <button class="btn btn--primary btn--large" id="downloadSelectedBtn" onclick="downloadSelectedSongs()">
                            <i class="fas fa-download"></i>
                            <span>Download Selected (<span id="selectedCount">0</span>)</span>
                        </button>
                    </div>
                    
                    <div class="playlist-items" id="playlistItems">
                        <!-- Playlist items will be inserted here -->
                    </div>
                </div>
                
                <!-- Active Download Progress -->
                <div class="progress-section hidden" id="progressSection">
                    <h2 class="section-title">
                        <i class="fas fa-spinner fa-spin"></i> Downloading...
                    </h2>
                    <div class="progress-card">
                        <img id="progressThumb" src="{{ url_for('static', filename='images/default-album.png') }}" alt="" class="progress-card__thumb" onerror="this.onerror=null;this.src='/static/images/default-album.png';">
                        <div class="progress-card__info">
                            <div class="progress-card__status-row">
                                <span class="progress-card__badge">In Progress</span>
                                <span id="progressPercent">0%</span>
                            </div>
                            <h4 id="progressTitle">Downloading...</h4>
                            <div class="progress-bar">
                                <div class="progress-bar__fill" id="progressFill"></div>
                            </div>
                            <div class="progress-stats">
                                <span id="progressSpeed">-- MB/s</span>
                                <span id="progressEta">--:--</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Success Message -->
                <div class="success-section hidden" id="successSection">
                    <div class="success-card">
                        <div class="success-icon">
                            <i class="fas fa-check"></i>
                        </div>
                        <h3>Download Complete!</h3>
                        <p id="successTitle">Your song has been downloaded</p>
                        <div class="success-actions">
                            <button class="btn btn--primary" onclick="playDownloaded()">
                                <i class="fas fa-play"></i> Play Now
                            </button>
                            <button class="btn btn--secondary" onclick="hideSuccess()">
                                Download Another
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- LIBRARY VIEW -->
            <div class="view hidden" id="libraryView">
                <h1 class="page-title">
                    <i class="fas fa-music"></i> My Music Library
                </h1>
                <p class="page-subtitle">Browse your downloads, play instantly, and manage tracks safely.</p>
                
                <!-- Library Search/Filter (Mobile) -->
                <div class="library-search">
                    <div class="library-search__input-wrapper">
                        <i class="fas fa-search"></i>
                        <input type="text" 
                               id="librarySearchInput" 
                               placeholder="Search your library...">
                    </div>
                </div>
                
                <div class="library-controls">
                    <span id="libraryCount">0 songs</span>
                    <div class="library-controls__actions">
                        <button class="btn btn--icon" onclick="toggleLibraryView()" title="Toggle view">
                            <i class="fas fa-table-cells-large" id="libraryViewIcon"></i>
                        </button>
                    </div>
                </div>
                
                <div class="library-grid" id="libraryGrid">
                    <div class="empty-state">
                        <i class="fas fa-music"></i>
                        <h3>No songs yet</h3>
                        <p>Downloaded songs will appear here</p>
                    </div>
                </div>
                <div class="library-load-status hidden" id="libraryLoadStatus"></div>
                <div class="library-load-trigger hidden" id="libraryLoadTrigger" aria-hidden="true"></div>
            </div>

            <!-- PLAYLISTS VIEW -->
            <div class="view hidden" id="playlistsView">
                <h1 class="page-title">
                    <i class="fas fa-compact-disc"></i> Playlists
                </h1>
                <p class="page-subtitle">Discover public playlists or manage your own collections.</p>

                <!-- Tab Bar -->
                <div class="playlist-tabs" role="tablist">
                    <button type="button" class="playlist-tab active" data-tab="explore"
                            onclick="switchPlaylistTab('explore')">
                        <i class="fas fa-compass"></i>
                        <span>Explore</span>
                    </button>
                    <button type="button" class="playlist-tab" data-tab="mine"
                            onclick="switchPlaylistTab('mine')">
                        <i class="fas fa-folder-open"></i>
                        <span>My Playlists</span>
                    </button>
                </div>

                <!-- ===== EXPLORE TAB ===== -->
                <div class="playlist-tab-content" id="playlistTabExplore">
                    <!-- Category Filter Bar -->
                    <div class="category-filter-bar" id="categoryFilterBar">
                        <button class="category-pill active" data-category="" onclick="filterByCategory(null)">
                            <i class="fas fa-globe"></i> All
                        </button>
                        <!-- Dynamic category pills inserted here -->
                    </div>

                    <!-- Sort Controls -->
                    <div class="explore-controls">
                        <select id="exploreSortSelect" class="explore-sort" onchange="loadExplorePlaylists()">
                            <option value="recent">Newest</option>
                            <option value="popular">Most Liked</option>
                        </select>
                    </div>

                    <!-- Explore Grid -->
                    <div class="playlist-grid" id="exploreGrid">
                        <div class="empty-state">
                            <i class="fas fa-compass"></i>
                            <h3>No public playlists yet</h3>
                            <p>Be the first to create a public playlist!</p>
                        </div>
                    </div>
                    <div class="explore-pagination" id="explorePagination"></div>
                </div>

                <!-- ===== MY PLAYLISTS TAB ===== -->
                <div class="playlist-tab-content hidden" id="playlistTabMine">
                    <div class="my-playlists-header">
                        <button class="btn btn--primary btn--small" onclick="openCreatePlaylistModal()">
                            <i class="fas fa-plus"></i>
                            <span>New Playlist</span>
                        </button>
                    </div>

                    <div class="playlist-grid" id="myPlaylistsGrid">
                        <div class="empty-state">
                            <i class="fas fa-folder-open"></i>
                            <h3>No playlists yet</h3>
                            <p>Create a playlist to organize your downloads</p>
                        </div>
                    </div>
                </div>

                <!-- ===== PLAYLIST DETAIL VIEW ===== -->
                <div class="playlist-tab-content hidden" id="playlistTabDetail">
                    <button class="playlist-detail-back" onclick="goBackFromPlaylistDetail()">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>

                    <div class="playlist-detail-header" id="playlistDetailHeader">
                        <!-- Dynamic: cover, title, owner, stats, actions -->
                    </div>

                    <div class="playlist-playback-controls" id="playlistDetailPlaybackControls">
                        <button class="btn btn--primary btn--small" id="playlistPlayAllBtn"
                                onclick="playSelectedPlaylist(false)" disabled>
                            <i class="fas fa-play"></i> <span>Play All</span>
                        </button>
                        <button class="btn btn--secondary btn--small" id="playlistShuffleBtn"
                                onclick="playSelectedPlaylist(true)" disabled>
                            <i class="fas fa-random"></i> <span>Shuffle</span>
                        </button>
                        <button class="btn btn--secondary btn--small playlist-loop-btn" id="playlistLoopBtn"
                                onclick="togglePlaylistLoop()" disabled title="Repeat: Off">
                            <i class="fas fa-repeat"></i><span></span>
                        </button>
                    </div>

                    <div id="playlistSongsList" class="playlist-songs-list">
                        <div class="empty-state">
                            <i class="fas fa-music"></i>
                            <h3>No songs in this playlist</h3>
                            <p>Add songs from your library</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- PLAYLIST DOWNLOADS VIEW -->
            <div class="view hidden" id="playlistDownloadsView">
                <h1 class="page-title">
                    <i class="fas fa-download"></i> Playlist Downloads
                </h1>
                <p class="page-subtitle">Track progress across each song with clear real-time status.</p>
                
                <div id="noActiveDownload" class="empty-state">
                    <i class="fas fa-music"></i>
                    <h3>No active playlist downloads</h3>
                    <p>Select songs from a playlist to start downloading</p>
                </div>
                
                <div id="activePlaylistDownload" class="hidden">
                    <!-- Overall Progress -->
                    <div class="overall-progress">
                        <div class="overall-progress__header">
                            <span id="overallStatus">Downloading...</span>
                            <span id="overallCount">0 of 0 completed</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-bar__fill" id="overallProgressBar"></div>
                        </div>
                        <div class="overall-progress__stats">
                            <span id="overallPercent">0%</span>
                        </div>
                    </div>
                    
                    <!-- Song List -->
                    <div class="playlist-download-list" id="playlistDownloadList">
                        <!-- Songs will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- PROFILE VIEW -->
            <div class="view hidden" id="profileView">
                <div class="view-header">
                    <h1 class="view-header__title"><i class="fas fa-user-circle"></i> My Profile</h1>
                </div>
                <div class="profile-container">
                    <div class="profile-card">
                        <div class="profile-card__avatar" id="profileAvatar"></div>
                        <div class="profile-card__info">
                            <div class="profile-field">
                                <label class="profile-field__label">Name</label>
                                <div class="profile-field__edit">
                                    <input type="text" id="profileNameInput" class="form-input" maxlength="100">
                                    <button class="btn btn--primary btn--sm" id="profileSaveNameBtn" onclick="handleSaveProfileName()">
                                        <i class="fas fa-check"></i> Save
                                    </button>
                                </div>
                            </div>
                            <div class="profile-field">
                                <label class="profile-field__label">Email</label>
                                <p class="profile-field__value" id="profileEmail"></p>
                            </div>
                            <div class="profile-field">
                                <label class="profile-field__label">Role</label>
                                <p class="profile-field__value"><span class="profile-badge" id="profileRole"></span></p>
                            </div>
                            <div class="profile-field">
                                <label class="profile-field__label">Auth Provider</label>
                                <p class="profile-field__value" id="profileAuthProvider"></p>
                            </div>
                            <div class="profile-field">
                                <label class="profile-field__label">Member Since</label>
                                <p class="profile-field__value" id="profileCreatedAt"></p>
                            </div>
                        </div>
                    </div>
                    <div class="profile-card" id="profilePasswordSection">
                        <h3 class="profile-card__title"><i class="fas fa-lock"></i> Change Password</h3>
                        <form class="auth-form" onsubmit="handleProfilePasswordChange(event)">
                            <div class="form-group">
                                <label for="profileCurrentPassword">Current Password</label>
                                <input type="password" id="profileCurrentPassword" class="form-input" placeholder="••••••••" required>
                            </div>
                            <div class="form-group">
                                <label for="profileNewPassword">New Password</label>
                                <input type="password" id="profileNewPassword" class="form-input" placeholder="Min 8 characters" required minlength="8">
                            </div>
                            <button type="submit" class="btn btn--primary" id="profileChangePasswordBtn">
                                <i class="fas fa-key"></i> Change Password
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- ADMIN VIEW -->
            <div class="view hidden" id="adminView">
                <h1 class="page-title">
                    <i class="fas fa-shield-alt"></i> Admin Panel
                </h1>

                <div class="admin-tabs">
                    <button class="admin-tab active" data-tab="users" onclick="switchAdminTab('users')">
                        <i class="fas fa-users"></i> Users
                    </button>
                    <button class="admin-tab" data-tab="categories" onclick="switchAdminTab('categories')">
                        <i class="fas fa-tags"></i> Categories
                    </button>
                    <button class="admin-tab" data-tab="audit" onclick="switchAdminTab('audit')">
                        <i class="fas fa-clipboard-list"></i> Audit Logs
                    </button>
                </div>

                <!-- Users Tab -->
                <div class="admin-panel" id="adminUsersPanel">
                    <div class="admin-toolbar">
                        <div class="admin-search">
                            <i class="fas fa-search"></i>
                            <input type="text" id="adminUserSearch" class="form-input" placeholder="Search users..." oninput="debounceAdminUserSearch()">
                        </div>
                    </div>
                    <div class="admin-table-wrap">
                        <table class="admin-table" id="adminUsersTable">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Last Login</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="adminUsersBody"></tbody>
                        </table>
                    </div>
                    <div class="admin-pagination" id="adminUsersPagination"></div>
                </div>

                <!-- Audit Logs Tab -->
                <div class="admin-panel hidden" id="adminAuditPanel">
                    <div class="admin-toolbar">
                        <div class="admin-search">
                            <i class="fas fa-filter"></i>
                            <select id="adminAuditFilter" class="form-input" onchange="loadAuditLogs(1)">
                                <option value="">All Actions</option>
                                <option value="DOWNLOAD_CREATE">Download Create</option>
                                <option value="SETTINGS_UPDATE">Settings Update</option>
                                <option value="HISTORY_CLEAR">History Clear</option>
                                <option value="SONG_DELETE">Song Delete</option>
                                <option value="USER_ROLE_CHANGE">Role Change</option>
                                <option value="USER_DEACTIVATE">User Deactivate</option>
                                <option value="USER_ACTIVATE">User Activate</option>
                            </select>
                        </div>
                    </div>
                    <div class="admin-table-wrap">
                        <table class="admin-table" id="adminAuditTable">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Actor</th>
                                    <th>Action</th>
                                    <th>Target</th>
                                    <th>Details</th>
                                    <th>IP</th>
                                </tr>
                            </thead>
                            <tbody id="adminAuditBody"></tbody>
                        </table>
                    </div>
                    <div class="admin-pagination" id="adminAuditPagination"></div>
                </div>

                <!-- Categories Tab -->
                <div class="admin-panel hidden" id="adminCategoriesPanel">
                    <div class="admin-toolbar">
                        <h3>Playlist Categories</h3>
                        <button class="btn btn--primary btn--small" onclick="openCreateCategoryForm()">
                            <i class="fas fa-plus"></i> Add Category
                        </button>
                    </div>
                    <div class="category-create-form hidden" id="categoryCreateForm">
                        <div class="form-row">
                            <input type="text" id="newCategoryName" class="form-input" placeholder="Category name" maxlength="60">
                            <input type="text" id="newCategoryIcon" class="form-input" placeholder="fa-music" value="fa-music" maxlength="30">
                            <input type="color" id="newCategoryColor" value="#6C5CE7" class="form-input form-input--color">
                            <button class="btn btn--primary btn--small" onclick="createCategory()">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn--secondary btn--small" onclick="closeCategoryForm()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div id="adminCategoriesList" class="admin-categories-list">
                        <div class="empty-state">
                            <i class="fas fa-tags"></i>
                            <h3>No categories</h3>
                            <p>Create categories for users to organize playlists</p>
                        </div>
                    </div>
                </div>
            </div>
            
        </main>
        
        <!-- Audio Player Bar -->
        <footer class="player hidden" id="playerBar">
            <div class="player__content">
                <!-- Track Info -->
                <div class="player__track">
                    <img id="playerThumb" src="" alt="" class="player__thumb">
                    <div class="player__info">
                        <span id="playerTitle" class="player__title">Not Playing</span>
                        <span id="playerArtist" class="player__artist">—</span>
                    </div>
                </div>
                
                <!-- Main Controls -->
                <div class="player__controls">
                    <button type="button" class="player__btn player__btn--icon" id="btnPrevTrack" title="Previous Track">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    
                    <button type="button" class="player__btn player__btn--skip" id="btnSkipBack" title="Back 10s">
                        <i class="fas fa-backward"></i>
                    </button>
                    
                    <button type="button" class="player__btn player__btn--play" id="playPauseBtn" title="Play/Pause">
                        <i class="fas fa-play"></i>
                    </button>
                    
                    <button type="button" class="player__btn player__btn--skip" id="btnSkipForward" title="Forward 10s">
                        <i class="fas fa-forward"></i>
                    </button>
                    
                    <button type="button" class="player__btn player__btn--icon" id="btnNextTrack" title="Next Track">
                        <i class="fas fa-step-forward"></i>
                    </button>
                    
                    <button type="button" class="player__btn player__btn--icon" id="btnRepeat" title="Repeat">
                        <i class="fas fa-repeat"></i>
                    </button>
                    
                    <!-- Mobile More Button -->
                    <button type="button" class="player__btn player__btn--more" id="btnMobileControls" title="More Controls">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
                
                <!-- Progress Section -->
                <div class="player__progress-section">
                    <span id="playerTime" class="player__time">0:00</span>
                    <div class="player__progress-bar" id="playerProgressBar">
                        <div class="player__progress-bg"></div>
                        <div class="player__progress-fill" id="playerProgress"></div>
                        <div class="player__progress-handle" id="playerHandle"></div>
                    </div>
                    <span id="playerDuration" class="player__time">0:00</span>
                </div>
                
                <!-- Extra Controls (Desktop) -->
                <div class="player__extra">
                    <div class="player__volume">
                        <button type="button" class="player__btn player__btn--icon" id="btnMute" title="Mute">
                            <i id="volumeIcon" class="fas fa-volume-up"></i>
                        </button>
                        <input type="range" class="player__volume-slider" id="volumeSlider" 
                               min="0" max="100" value="100">
                    </div>
                    
                    <button type="button" class="player__btn player__btn--icon" id="btnSleepTimer" title="Sleep Timer">
                        <i class="fas fa-moon"></i>
                        <span id="sleepTimerDisplay" class="player__timer-badge"></span>
                    </button>
                </div>
                
                <!-- Loading Indicator -->
                <div id="playerLoading" class="player__loading">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
            </div>
            
            <audio id="audioPlayer" preload="metadata"></audio>
        </footer>
        
        <!-- Mobile Bottom Navigation -->
        <nav class="mobile-nav" id="mobileNav">
            <a class="mobile-nav__item" data-role="admin" onclick="showView('download')">
                <i class="fas fa-download"></i>
                <span>Download</span>
            </a>
            <a class="mobile-nav__item active" onclick="showView('library')">
                <i class="fas fa-music"></i>
                <span>Library</span>
            </a>
            <a class="mobile-nav__item" onclick="showView('playlists')">
                <i class="fas fa-list-ul"></i>
                <span>Playlists</span>
            </a>
        </nav>
    </div>
    
    <!-- Now Playing Panel (Spotify-style) -->
    <div class="now-playing" id="nowPlayingPanel">
        <div class="now-playing__header">
            <button type="button" class="now-playing__close" id="btnCloseNowPlaying">
                <i class="fas fa-chevron-down"></i>
            </button>
            <span class="now-playing__label">Now Playing</span>
            <div class="now-playing__spacer"></div>
        </div>
        <div class="now-playing__artwork">
            <img id="nowPlayingThumb" src="/static/images/default-album.png" alt="">
        </div>
        <div class="now-playing__info">
            <div class="now-playing__title" id="nowPlayingTitle">Not Playing</div>
            <div class="now-playing__artist" id="nowPlayingArtist">—</div>
        </div>
        <div class="now-playing__progress">
            <div class="now-playing__progress-bar" id="nowPlayingProgressBar">
                <div class="now-playing__progress-fill" id="nowPlayingProgress"></div>
            </div>
            <div class="now-playing__times">
                <span id="nowPlayingTime">0:00</span>
                <span id="nowPlayingDuration">0:00</span>
            </div>
        </div>
        <div class="now-playing__controls">
                <button type="button" class="now-playing__btn" id="btnShuffleNP"><i class="fas fa-random"></i></button>
                <button type="button" class="now-playing__btn" id="btnPrevTrackNP"><i class="fas fa-step-backward"></i></button>
                <button type="button" class="now-playing__btn" id="btnSkipBackNP"><i class="fas fa-backward"></i></button>
                <button type="button" class="now-playing__btn now-playing__btn--play" id="btnPlayPauseNP"><i class="fas fa-play"></i></button>
                <button type="button" class="now-playing__btn" id="btnSkipForwardNP"><i class="fas fa-forward"></i></button>
                <button type="button" class="now-playing__btn" id="btnNextTrackNP"><i class="fas fa-step-forward"></i></button>
                <button type="button" class="now-playing__btn" id="btnRepeatNP"><i class="fas fa-repeat"></i></button>
        </div>
        <div class="now-playing__extras">
            <div class="now-playing__volume">
                <i class="fas fa-volume-down"></i>
                <input type="range" class="now-playing__slider" id="nowPlayingVolume" min="0" max="100" value="100">
                <i class="fas fa-volume-up"></i>
            </div>
            
            <button type="button" class="now-playing__extra-btn" id="btnSleepTimerNP">
                <i class="fas fa-moon"></i>
                <span>Sleep Timer</span>
                <span class="sleep-timer-countdown hidden" id="sleepTimerCountdown"></span>
            </button>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal-overlay hidden" id="settingsModal" onclick="closeSettingsOnOverlay(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal__header">
                <h2><i class="fas fa-cog"></i> Settings</h2>
                <button class="modal__close" onclick="closeSettings()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="settingsForm" onsubmit="saveSettings(event)">
                <div class="form-group">
                    <label>Download Folder</label>
                    <input type="text"
                           id="settingsDownloadDir"
                           class="form-input"
                           placeholder="/path/to/downloads">
                </div>
                <div class="form-group">
                    <label>Default Audio Format</label>
                    <select id="settingsFormat" class="form-input">
                        <option value="m4a">M4A — Best for iPhone</option>
                        <option value="mp3">MP3 — Universal</option>
                        <option value="flac">FLAC — Lossless Quality</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Audio Quality</label>
                    <select id="settingsQuality" class="form-input">
                        <option value="320">320 kbps — Best</option>
                        <option value="256">256 kbps</option>
                        <option value="192">192 kbps</option>
                        <option value="128">128 kbps — Smallest</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Playlist Preview Cap</label>
                    <input type="number"
                           id="settingsPlaylistPreviewLimit"
                           class="form-input"
                           min="20"
                           max="500"
                           step="1"
                           value="120"
                           placeholder="120">
                    <small class="text-muted">Max songs loaded in playlist/Mix preview (20-500). Lower is faster on Termux.</small>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="settingsDuplicates" checked disabled>
                        <span class="checkbox-custom"></span>
                        Prevent duplicate downloads (always on)
                    </label>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="settingsHaptic" checked>
                        <span class="checkbox-custom"></span>
                        Haptic feedback (vibration)
                    </label>
                </div>
                <button type="submit" class="btn btn--primary btn--full">
                    Save Settings
                </button>
            </form>
        </div>
    </div>
    
    <!-- Sleep Timer Modal -->
    <div class="modal-overlay hidden" id="sleepTimerModal" onclick="closeSleepTimerModal(event)">
        <div class="modal modal--compact" onclick="event.stopPropagation()">
            <div class="modal__header">
                <h2><i class="fas fa-moon"></i> Sleep Timer</h2>
                <button class="modal__close" onclick="closeSleepTimerMenu()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="sleep-timer-options">
                <button class="sleep-timer-btn" onclick="setSleepTimer(15)">15 minutes</button>
                <button class="sleep-timer-btn" onclick="setSleepTimer(30)">30 minutes</button>
                <button class="sleep-timer-btn" onclick="setSleepTimer(45)">45 minutes</button>
                <button class="sleep-timer-btn" onclick="setSleepTimer(60)">1 hour</button>
                <button class="sleep-timer-btn" onclick="setSleepTimer(90)">1.5 hours</button>
                <button class="sleep-timer-btn sleep-timer-btn--cancel" onclick="setSleepTimer(0)">
                    <i class="fas fa-times"></i> Cancel Timer
                </button>
            </div>
        </div>
    </div>

    <!-- Add To Playlist Modal -->
    <div class="modal-overlay hidden" id="addToPlaylistModal" onclick="closeAddToPlaylistModalOnOverlay(event)">
        <div class="modal modal--compact" onclick="event.stopPropagation()">
            <div class="modal__header">
                <h2><i class="fas fa-list-music"></i> Add to Playlist</h2>
                <button class="modal__close" onclick="closeAddToPlaylistModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="form-group">
                <label>Create New Playlist</label>
                <div class="playlists-create playlists-create--modal">
                    <input type="text"
                           id="modalPlaylistName"
                           class="form-input"
                           placeholder="Playlist name..."
                           maxlength="120"
                           onkeypress="if (event.key === 'Enter') createPlaylistFromModal()">
                    <button class="btn btn--primary btn--small" onclick="createPlaylistFromModal()">
                        <i class="fas fa-plus"></i>
                        <span>Create</span>
                    </button>
                </div>
            </div>

            <div id="addToPlaylistOptions" class="add-to-playlist-options"></div>
        </div>
    </div>

    <!-- Add Songs To Selected Playlist Modal -->
    <div class="modal-overlay hidden" id="addSongsToPlaylistModal" onclick="closeAddSongsToPlaylistModalOnOverlay(event)">
        <div class="modal playlist-add-modal" onclick="event.stopPropagation()">
            <div class="playlist-add-modal__header">
                <div class="playlist-add-modal__heading">
                    <p class="playlist-add-modal__eyebrow">Add To Playlist</p>
                    <h2 id="addSongsToPlaylistTitle">Playlist</h2>
                </div>
                <button class="modal__close" onclick="closeAddSongsToSelectedPlaylistModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="playlist-add-modal__search">
                <i class="fas fa-search"></i>
                <input type="text"
                       id="addSongsSearchInput"
                       class="form-input form-input--square"
                       placeholder="Search songs in your library..."
                       autocomplete="off"
                       oninput="onAddSongsSearchInput(this.value)">
            </div>

            <p class="text-muted playlist-add-modal__hint" id="addSongsModalHint">
                Search your library and add songs instantly.
            </p>

            <div id="addSongsToPlaylistList" class="playlist-add-modal__list"></div>
        </div>
    </div>

    <!-- Confirm Action Modal -->
    <div class="modal-overlay hidden" id="confirmActionModal" onclick="closeConfirmActionOnOverlay(event)">
        <div class="modal modal--compact confirm-modal" onclick="event.stopPropagation()">
            <div class="modal__header">
                <h2 id="confirmActionTitle"><i class="fas fa-shield-alt"></i> Confirm Action</h2>
                <button class="modal__close" onclick="cancelConfirmAction()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <p class="confirm-modal__message" id="confirmActionMessage">Are you sure you want to continue?</p>

            <div class="form-group hidden" id="confirmActionInputGroup">
                <label id="confirmActionInputLabel" for="confirmActionInput">Type confirmation text</label>
                <input type="text"
                       id="confirmActionInput"
                       class="form-input form-input--square"
                       autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       spellcheck="false">
                <p class="text-muted confirm-modal__hint" id="confirmActionInputHint"></p>
            </div>

            <div class="confirm-modal__actions">
                <button class="btn btn--secondary" onclick="cancelConfirmAction()">
                    Cancel
                </button>
                <button class="btn btn--danger" id="confirmActionSubmitBtn" onclick="submitConfirmAction()">
                    Confirm
                </button>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loader-overlay hidden" id="loaderOverlay">
        <div class="loader-spinner"></div>
        <div class="loader-text" id="loaderText">Loading...</div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Floating Sleep Timer Indicator -->
    <div class="sleep-timer-floating hidden" id="sleepTimerFloating" onclick="showSleepTimerMenu()">
        <i class="fas fa-moon"></i>
        <span id="sleepTimerFloatingTime"></span>
    </div>
    
    <!-- Seek Preview (for touch gestures) -->
    <div class="seek-preview" id="seekPreview" style="display: none;"></div>
    
    <!-- Volume Indicator (for touch gestures) -->
    <div class="volume-indicator" id="volumeIndicator" style="display: none;"></div>
    
    <!-- Skip Indicator -->
    <div class="skip-indicator" id="skipIndicator"></div>
    
        <!-- Lyrics Panel -->
        <div class="lyrics-panel hidden" id="lyricsPanel">
            <div class="lyrics-panel__content">
                <button class="lyrics-panel__close" onclick="Player.toggleLyrics()">
                    <i class="fas fa-times"></i>
                </button>
                <div class="lyrics-panel__placeholder">
                    <i class="fas fa-music"></i>
                    <p>Lyrics will appear here when playing</p>
                </div>
            </div>
        </div>
        <!-- Cast Indicator -->
        <div class="cast-indicator hidden" id="castIndicator">
            <i class="fas fa-chromecast"></i>
            <span>Casting to device...</span>
        </div>
        <!-- Accessibility Mode Indicator -->
        <div class="accessibility-indicator hidden" id="accessibilityIndicator">
            <i class="fas fa-universal-access"></i>
            <span>Accessibility mode enabled</span>
        </div>
        <!-- Theme Indicator -->
        <div class="theme-indicator hidden" id="themeIndicator">
            <i class="fas fa-moon"></i>
            <span>Dark theme</span>
        </div>
    
    <!-- JavaScript Modules -->
    <script src="{{ url_for('static', filename='js/ui.js') }}"></script>
    <script src="{{ url_for('static', filename='js/api.js') }}"></script>
    <script src="{{ url_for('static', filename='js/player.js') }}"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
    <script src="{{ url_for('static', filename='js/downloads.js') }}"></script>
    <script src="{{ url_for('static', filename='js/admin.js') }}"></script>
    <script src="{{ url_for('static', filename='js/playlists.js') }}"></script>
    <script src="{{ url_for('static', filename='js/library.js') }}"></script>
    <script src="{{ url_for('static', filename='js/playback.js') }}"></script>
    <!-- Initialize Player -->
    <script>
        window.addEventListener('load', () => {
            Player.init();
            
            // Initialize indicators
            if (Player.castEnabled) {
                document.getElementById('castIndicator').classList.add('show');
            }
            if (Player.accessibilityMode) {
                document.getElementById('accessibilityIndicator').classList.add('show');
            }
            if (Player.darkTheme) {
                document.getElementById('themeIndicator').classList.add('show');
            }
        });
    </script>
    
    <!-- Mobile Helper Functions -->
    <script>
        // Sidebar toggle for mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('open');
            document.body.classList.toggle('sidebar-open');
        }
        
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('open');
            document.body.classList.remove('sidebar-open');
        }
        
        // Update mobile nav active state
        function updateMobileNav(viewName) {
            const items = document.querySelectorAll('.mobile-nav__item');
            items.forEach(item => item.classList.remove('active'));
            
            const viewMap = {
                'download': 0,
                'library': 1,
                'playlists': 1,
                'playlist-downloads': 2
            };
            
            if (viewMap[viewName] !== undefined) {
                items[viewMap[viewName]]?.classList.add('active');
            }
        }
        
        // Sleep timer modal
        function showSleepTimerMenu() {
            document.getElementById('sleepTimerModal').classList.remove('hidden');
        }
        
        function closeSleepTimerMenu() {
            document.getElementById('sleepTimerModal').classList.add('hidden');
        }
        
        function closeSleepTimerModal(event) {
            if (event.target.id === 'sleepTimerModal') {
                closeSleepTimerMenu();
            }
        }
        
        function setSleepTimer(minutes) {
            Player.setSleepTimer(minutes);
            closeSleepTimerMenu();
        }
        
        // Close settings on overlay click
        function closeSettingsOnOverlay(event) {
            if (event.target.id === 'settingsModal') {
                closeSettings();
            }
        }
        
        // Offline detection UI
        window.addEventListener('online', () => {
            document.getElementById('offlineBanner').style.display = 'none';
        });
        
        window.addEventListener('offline', () => {
            document.getElementById('offlineBanner').style.display = 'flex';
        });
        
        // Check initial state
        if (!navigator.onLine) {
            document.getElementById('offlineBanner').style.display = 'flex';
        }
        
        // Prevent zoom on double tap for iOS (but allow interactive elements)
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (event) => {
            // Skip for interactive elements to avoid breaking button/input behavior
            if (event.target.closest('input, textarea, button, a, select, [onclick]')) {
                return;
            }
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, { passive: false });
        
        // Handle safe area insets for notched devices
        function updateSafeAreas() {
            const root = document.documentElement;
            root.style.setProperty('--safe-area-top', 'env(safe-area-inset-top)');
            root.style.setProperty('--safe-area-bottom', 'env(safe-area-inset-bottom)');
            root.style.setProperty('--safe-area-left', 'env(safe-area-inset-left)');
            root.style.setProperty('--safe-area-right', 'env(safe-area-inset-right)');
        }
        updateSafeAreas();
        
        // Mobile nav sync is handled inside showView() in app.js
    </script>
</body>
</html>
