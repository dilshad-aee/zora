<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="Zora - Download and play music from YouTube">
    
    <title>Zora - YouTube Music Downloader</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='logo.png') }}">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="app">
        <!-- Mobile Header -->
        <header class="mobile-header" id="mobileHeader">
            <button class="mobile-header__menu" id="menuToggle" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <div class="mobile-header__brand">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="Zora" class="mobile-header__logo">
                <span>Zora</span>
            </div>
            <button class="mobile-header__action" onclick="openSettings()">
                <i class="fas fa-cog"></i>
            </button>
        </header>

        <!-- Sidebar Overlay (Mobile) -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
        
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar__brand">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="Zora" class="sidebar__logo">
                <span>Zora</span>
            </div>
            
            <nav class="sidebar__nav">
                <a class="nav-link active" onclick="showView('download'); closeSidebar();">
                    <i class="fas fa-download"></i>
                    <span>Download</span>
                </a>
                <a class="nav-link" onclick="showView('library'); closeSidebar();">
                    <i class="fas fa-music"></i>
                    <span>My Music</span>
                </a>
                <a class="nav-link" onclick="showView('queue'); closeSidebar();">
                    <i class="fas fa-list"></i>
                    <span>Queue</span>
                    <span class="nav-badge" id="queueBadge" style="display: none;">0</span>
                </a>
                <a class="nav-link" onclick="showView('playlist-downloads'); closeSidebar();">
                    <i class="fas fa-download"></i>
                    <span>Playlist Downloads</span>
                    <span class="nav-badge" id="playlistDownloadBadge" style="display: none;">0</span>
                </a>
            </nav>
            
            <div class="sidebar__footer">
                <button class="sidebar__btn" onclick="openFolder()">
                    <i class="fas fa-folder-open"></i>
                    <span>Open Folder</span>
                </button>
                <button class="sidebar__btn" onclick="openSettings(); closeSidebar();">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </button>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main" id="mainContent">
            
            <!-- DOWNLOAD VIEW -->
            <div class="view" id="downloadView">
                <div class="hero">
                    <h1 class="hero__title">
                        <img src="{{ url_for('static', filename='logo.png') }}" alt="" class="hero__logo">
                        <span class="hero__title-text">Download Music with Zora</span>
                    </h1>
                    <p class="hero__subtitle">Paste a YouTube link or search for your favorite songs</p>
                    
                    <!-- Search Box -->
                    <div class="search-box">
                        <div class="search-box__tabs">
                            <button class="tab active" id="tabUrl" onclick="switchTab('url')">
                                <i class="fas fa-link"></i>
                                <span class="tab__text">Paste URL</span>
                            </button>
                            <button class="tab" id="tabPlaylist" onclick="switchTab('playlist')">
                                <i class="fas fa-list"></i>
                                <span class="tab__text">Playlist</span>
                            </button>
                            <button class="tab" id="tabSearch" onclick="switchTab('search')">
                                <i class="fas fa-search"></i>
                                <span class="tab__text">Search</span>
                            </button>
                        </div>
                        
                        <div class="search-box__input-wrapper">
                            <input type="text" 
                                   id="mainInput" 
                                   class="search-input"
                                   placeholder="Paste YouTube or YouTube Music URL here..."
                                   autocomplete="off"
                                   autocorrect="off"
                                   autocapitalize="off"
                                   spellcheck="false"
                                   enterkeyhint="go">
                            <button class="search-btn" id="mainBtn" onclick="handleMainAction()">
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                        
                        <p class="search-hint" id="searchHint">
                            <i class="fas fa-info-circle"></i>
                            Supports: youtube.com, youtu.be, music.youtube.com
                        </p>
                    </div>
                </div>
                
                <!-- Search Results -->
                <div class="results-section hidden" id="resultsSection">
                    <h2 class="section-title">
                        <i class="fas fa-search"></i> Search Results
                        <button class="clear-btn" onclick="clearResults()">Clear</button>
                    </h2>
                    <div class="results-grid" id="resultsGrid"></div>
                </div>
                
                <!-- Ready to Download Card -->
                <div class="download-ready hidden" id="downloadReady">
                    <div class="download-card">
                        <img id="previewThumb" src="" alt="" class="download-card__image">
                        <div class="download-card__info">
                            <h3 id="previewTitle" class="download-card__title">Song Title</h3>
                            <p id="previewArtist" class="download-card__artist">Artist Name</p>
                            <div class="download-card__meta">
                                <span id="previewDuration"><i class="fas fa-clock"></i> 0:00</span>
                                <span id="previewViews"><i class="fas fa-eye"></i> 0 views</span>
                            </div>
                            
                            <!-- Duplicate Warning -->
                            <div class="warning-banner hidden" id="duplicateWarning">
                                <i class="fas fa-exclamation-triangle"></i>
                                This song is already in your library
                            </div>
                        </div>
                        
                        <div class="download-card__actions">
                            <div class="format-picker">
                                <label>Format:</label>
                                <select id="formatSelect" class="format-select">
                                    <option value="m4a" selected>M4A (iPhone)</option>
                                    <option value="mp3">MP3 (Universal)</option>
                                    <option value="flac">FLAC (Lossless)</option>
                                </select>
                            </div>
                            
                            <button class="btn btn--primary btn--large" id="downloadNowBtn" onclick="startDownload()">
                                <i class="fas fa-download"></i>
                                <span>Download Now</span>
                            </button>
                            
                            <button class="btn btn--secondary" onclick="addToQueue()">
                                <i class="fas fa-plus"></i>
                                <span>Add to Queue</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Playlist Preview Section -->
                <div class="playlist-preview hidden" id="playlistPreview">
                    <h2 class="section-title">
                        <i class="fas fa-list"></i> 
                        <span id="playlistTitle">Playlist</span>
                        <span id="playlistCount" class="text-muted">(0 songs)</span>
                    </h2>
                    
                    <div class="playlist-controls">
                        <button class="btn btn--secondary btn--small" onclick="selectAllSongs()">
                            <i class="fas fa-check-square"></i>
                            <span class="btn-text">Select All</span>
                        </button>
                        <button class="btn btn--secondary btn--small" onclick="deselectAllSongs()">
                            <i class="fas fa-square"></i>
                            <span class="btn-text">Deselect All</span>
                        </button>
                        <button class="btn btn--primary btn--large" id="downloadSelectedBtn" onclick="downloadSelectedSongs()">
                            <i class="fas fa-download"></i>
                            <span>Download Selected (<span id="selectedCount">0</span>)</span>
                        </button>
                    </div>
                    
                    <div class="playlist-items" id="playlistItems">
                        <!-- Playlist items will be inserted here -->
                    </div>
                </div>
                
                <!-- Active Download Progress -->
                <div class="progress-section hidden" id="progressSection">
                    <h2 class="section-title">
                        <i class="fas fa-spinner fa-spin"></i> Downloading...
                    </h2>
                    <div class="progress-card">
                        <img id="progressThumb" src="" alt="" class="progress-card__thumb">
                        <div class="progress-card__info">
                            <h4 id="progressTitle">Downloading...</h4>
                            <div class="progress-bar">
                                <div class="progress-bar__fill" id="progressFill"></div>
                            </div>
                            <div class="progress-stats">
                                <span id="progressPercent">0%</span>
                                <span id="progressSpeed">-- MB/s</span>
                                <span id="progressEta">--:--</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Success Message -->
                <div class="success-section hidden" id="successSection">
                    <div class="success-card">
                        <div class="success-icon">
                            <i class="fas fa-check"></i>
                        </div>
                        <h3>Download Complete!</h3>
                        <p id="successTitle">Your song has been downloaded</p>
                        <div class="success-actions">
                            <button class="btn btn--primary" onclick="playDownloaded()">
                                <i class="fas fa-play"></i> Play Now
                            </button>
                            <button class="btn btn--secondary" onclick="hideSuccess()">
                                Download Another
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- LIBRARY VIEW -->
            <div class="view hidden" id="libraryView">
                <h1 class="page-title">
                    <i class="fas fa-music"></i> My Music Library
                </h1>
                
                <!-- Library Search/Filter (Mobile) -->
                <div class="library-search">
                    <div class="library-search__input-wrapper">
                        <i class="fas fa-search"></i>
                        <input type="text" 
                               id="librarySearchInput" 
                               placeholder="Search your library..."
                               oninput="filterLibrary(this.value)">
                    </div>
                </div>
                
                <div class="library-controls">
                    <span id="libraryCount">0 songs</span>
                    <div class="library-controls__actions">
                        <button class="btn btn--icon" onclick="toggleLibraryView()" title="Toggle view">
                            <i class="fas fa-th" id="libraryViewIcon"></i>
                        </button>
                        <button class="btn btn--secondary btn--small" onclick="openFolder()">
                            <i class="fas fa-folder-open"></i>
                            <span class="btn-text">Open Folder</span>
                        </button>
                    </div>
                </div>
                
                <div class="library-grid" id="libraryGrid">
                    <div class="empty-state">
                        <i class="fas fa-music"></i>
                        <h3>No songs yet</h3>
                        <p>Downloaded songs will appear here</p>
                    </div>
                </div>
            </div>
            
            <!-- QUEUE VIEW -->
            <div class="view hidden" id="queueView">
                <h1 class="page-title">
                    <i class="fas fa-list"></i> Download Queue
                </h1>
                
                <div class="queue-controls">
                    <span id="queueCount">0 items in queue</span>
                    <button class="btn btn--danger btn--small" onclick="clearQueue()" id="clearQueueBtn" style="display: none;">
                        <i class="fas fa-trash"></i>
                        <span class="btn-text">Clear All</span>
                    </button>
                </div>
                
                <div class="queue-list" id="queueList">
                    <div class="empty-state">
                        <i class="fas fa-list"></i>
                        <h3>Queue is empty</h3>
                        <p>Add songs to download them one by one</p>
                    </div>
                </div>
            </div>
            
            <!-- PLAYLIST DOWNLOADS VIEW -->
            <div class="view hidden" id="playlistDownloadsView">
                <h1 class="page-title">
                    <i class="fas fa-download"></i> Playlist Downloads
                </h1>
                
                <div id="noActiveDownload" class="empty-state">
                    <i class="fas fa-music"></i>
                    <h3>No active playlist downloads</h3>
                    <p>Select songs from a playlist to start downloading</p>
                </div>
                
                <div id="activePlaylistDownload" class="hidden">
                    <!-- Overall Progress -->
                    <div class="overall-progress">
                        <div class="overall-progress__header">
                            <span id="overallStatus">Downloading...</span>
                            <span id="overallCount">0 of 0 completed</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-bar__fill" id="overallProgressBar"></div>
                        </div>
                        <div class="overall-progress__stats">
                            <span id="overallPercent">0%</span>
                        </div>
                    </div>
                    
                    <!-- Song List -->
                    <div class="playlist-download-list" id="playlistDownloadList">
                        <!-- Songs will be inserted here -->
                    </div>
                </div>
            </div>
            
        </main>
        
        <!-- Audio Player Bar -->
        <footer class="player hidden" id="playerBar">
            <div class="player__content">
                <!-- Track Info -->
                <div class="player__track">
                    <img id="playerThumb" src="" alt="" class="player__thumb">
                    <div class="player__info">
                        <span id="playerTitle" class="player__title">Not Playing</span>
                        <span id="playerArtist" class="player__artist">—</span>
                    </div>
                </div>
                
                <!-- Main Controls -->
                <div class="player__controls">
                    <button type="button" class="player__btn player__btn--icon" id="btnPrevTrack" title="Previous Track">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    
                    <button type="button" class="player__btn player__btn--skip" id="btnSkipBack" title="Back 10s">
                        <i class="fas fa-backward"></i>
                    </button>
                    
                    <button type="button" class="player__btn player__btn--play" id="playPauseBtn" title="Play/Pause">
                        <i class="fas fa-play"></i>
                    </button>
                    
                    <button type="button" class="player__btn player__btn--skip" id="btnSkipForward" title="Forward 10s">
                        <i class="fas fa-forward"></i>
                    </button>
                    
                    <button type="button" class="player__btn player__btn--icon" id="btnNextTrack" title="Next Track">
                        <i class="fas fa-step-forward"></i>
                    </button>
                    
                    <button type="button" class="player__btn player__btn--icon" id="btnRepeat" title="Repeat">
                        <i class="fas fa-repeat"></i>
                    </button>
                    
                    <!-- Mobile More Button -->
                    <button type="button" class="player__btn player__btn--more" id="btnMobileControls" title="More Controls">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
                
                <!-- Progress Section -->
                <div class="player__progress-section">
                    <span id="playerTime" class="player__time">0:00</span>
                    <div class="player__progress-bar" id="playerProgressBar">
                        <div class="player__progress-bg"></div>
                        <div class="player__progress-fill" id="playerProgress"></div>
                        <div class="player__progress-handle" id="playerHandle"></div>
                    </div>
                    <span id="playerDuration" class="player__time">0:00</span>
                </div>
                
                <!-- Extra Controls (Desktop) -->
                <div class="player__extra">
                    <div class="player__volume">
                        <button type="button" class="player__btn player__btn--icon" id="btnMute" title="Mute">
                            <i id="volumeIcon" class="fas fa-volume-up"></i>
                        </button>
                        <input type="range" class="player__volume-slider" id="volumeSlider" 
                               min="0" max="100" value="100">
                    </div>
                    
                    <button type="button" class="player__btn player__btn--icon" id="btnSleepTimer" title="Sleep Timer">
                        <i class="fas fa-moon"></i>
                        <span id="sleepTimerDisplay" class="player__timer-badge"></span>
                    </button>
                </div>
                
                <!-- Loading Indicator -->
                <div id="playerLoading" class="player__loading">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
            </div>
            
            <audio id="audioPlayer" preload="metadata"></audio>
        </footer>
        
        <!-- Mobile Bottom Navigation -->
        <nav class="mobile-nav" id="mobileNav">
            <a class="mobile-nav__item active" onclick="showView('download')">
                <i class="fas fa-download"></i>
                <span>Download</span>
            </a>
            <a class="mobile-nav__item" onclick="showView('library')">
                <i class="fas fa-music"></i>
                <span>Library</span>
            </a>
            <a class="mobile-nav__item" onclick="showView('queue')">
                <i class="fas fa-list"></i>
                <span>Queue</span>
                <span class="mobile-nav__badge" id="mobileQueueBadge" style="display: none;">0</span>
            </a>
        </nav>
    </div>
    
    <!-- Now Playing Panel (Spotify-style) -->
    <div class="now-playing" id="nowPlayingPanel">
        <div class="now-playing__header">
            <button type="button" class="now-playing__close" id="btnCloseNowPlaying">
                <i class="fas fa-chevron-down"></i>
            </button>
            <span class="now-playing__label">Now Playing</span>
            <div class="now-playing__spacer"></div>
        </div>
        <div class="now-playing__artwork">
            <img id="nowPlayingThumb" src="/static/images/default-album.png" alt="">
        </div>
        <div class="now-playing__info">
            <div class="now-playing__title" id="nowPlayingTitle">Not Playing</div>
            <div class="now-playing__artist" id="nowPlayingArtist">—</div>
        </div>
        <div class="now-playing__progress">
            <div class="now-playing__progress-bar" id="nowPlayingProgressBar">
                <div class="now-playing__progress-fill" id="nowPlayingProgress"></div>
            </div>
            <div class="now-playing__times">
                <span id="nowPlayingTime">0:00</span>
                <span id="nowPlayingDuration">0:00</span>
            </div>
        </div>
        <div class="now-playing__controls">
                <button type="button" class="now-playing__btn" id="btnShuffleNP"><i class="fas fa-random"></i></button>
                <button type="button" class="now-playing__btn now-playing__btn--skip" id="btnPrevTrackNP"><i class="fas fa-step-backward"></i></button>
                <button type="button" class="now-playing__btn now-playing__btn--play" id="btnPlayPauseNP"><i class="fas fa-play"></i></button>
                <button type="button" class="now-playing__btn now-playing__btn--skip" id="btnSkipForwardNP"><i class="fas fa-step-forward"></i></button>
                <button type="button" class="now-playing__btn" id="btnRepeatNP"><i class="fas fa-repeat"></i></button>
                <button type="button" class="now-playing__btn" id="btnEqualizerNP"><i class="fas fa-dumbbell"></i></button>
                <button type="button" class="now-playing__btn" id="btnLyricsNP"><i class="fas fa-music"></i></button>
                <button type="button" class="now-playing__btn" id="btnCastNP"><i class="fas fa-chromecast"></i></button>
                <button type="button" class="now-playing__btn" id="btnOfflineNP"><i class="fas fa-wifi-slash"></i></button>
                <button type="button" class="now-playing__btn" id="btnAccessibilityNP"><i class="fas fa-universal-access"></i></button>
                <button type="button" class="now-playing__btn" id="btnSleepTimerNP"><i class="fas fa-moon"></i></button>
        <div class="now-playing__extras">
            <div class="now-playing__volume">
                <i class="fas fa-volume-down"></i>
                <input type="range" class="now-playing__slider" id="nowPlayingVolume" min="0" max="100" value="100">
                <i class="fas fa-volume-up"></i>
            </div>
            
            <button type="button" class="now-playing__extra-btn" id="btnSleepTimerNP">
                <i class="fas fa-moon"></i>
                <span>Sleep Timer</span>
            </button>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal-overlay hidden" id="settingsModal" onclick="closeSettingsOnOverlay(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal__header">
                <h2><i class="fas fa-cog"></i> Settings</h2>
                <button class="modal__close" onclick="closeSettings()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="settingsForm" onsubmit="saveSettings(event)">
                <div class="form-group">
                    <label>Default Audio Format</label>
                    <select id="settingsFormat" class="form-input">
                        <option value="m4a">M4A — Best for iPhone</option>
                        <option value="mp3">MP3 — Universal</option>
                        <option value="flac">FLAC — Lossless Quality</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Audio Quality</label>
                    <select id="settingsQuality" class="form-input">
                        <option value="320">320 kbps — Best</option>
                        <option value="256">256 kbps</option>
                        <option value="192">192 kbps</option>
                        <option value="128">128 kbps — Smallest</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="settingsDuplicates" checked>
                        <span class="checkbox-custom"></span>
                        Warn about duplicate downloads
                    </label>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="settingsHaptic" checked>
                        <span class="checkbox-custom"></span>
                        Haptic feedback (vibration)
                    </label>
                </div>
                <button type="submit" class="btn btn--primary btn--full">
                    Save Settings
                </button>
            </form>
        </div>
    </div>
    
    <!-- Sleep Timer Modal -->
    <div class="modal-overlay hidden" id="sleepTimerModal" onclick="closeSleepTimerModal(event)">
        <div class="modal modal--compact" onclick="event.stopPropagation()">
            <div class="modal__header">
                <h2><i class="fas fa-moon"></i> Sleep Timer</h2>
                <button class="modal__close" onclick="closeSleepTimerMenu()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="sleep-timer-options">
                <button class="sleep-timer-btn" onclick="setSleepTimer(15)">15 minutes</button>
                <button class="sleep-timer-btn" onclick="setSleepTimer(30)">30 minutes</button>
                <button class="sleep-timer-btn" onclick="setSleepTimer(45)">45 minutes</button>
                <button class="sleep-timer-btn" onclick="setSleepTimer(60)">1 hour</button>
                <button class="sleep-timer-btn" onclick="setSleepTimer(90)">1.5 hours</button>
                <button class="sleep-timer-btn sleep-timer-btn--cancel" onclick="setSleepTimer(0)">
                    <i class="fas fa-times"></i> Cancel Timer
                </button>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loader-overlay hidden" id="loaderOverlay">
        <div class="loader-spinner"></div>
        <div class="loader-text" id="loaderText">Loading...</div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Seek Preview (for touch gestures) -->
    <div class="seek-preview" id="seekPreview" style="display: none;"></div>
    
    <!-- Volume Indicator (for touch gestures) -->
    <div class="volume-indicator" id="volumeIndicator" style="display: none;"></div>
    
    <!-- Skip Indicator -->
    <div class="skip-indicator" id="skipIndicator"></div>
    
        <!-- Lyrics Panel -->
        <div class="lyrics-panel hidden" id="lyricsPanel">
            <div class="lyrics-panel__content">
                <button class="lyrics-panel__close" onclick="Player.toggleLyrics()">
                    <i class="fas fa-times"></i>
                </button>
                <div class="lyrics-panel__placeholder">
                    <i class="fas fa-music"></i>
                    <p>Lyrics will appear here when playing</p>
                </div>
            </div>
        </div>
        <!-- Cast Indicator -->
        <div class="cast-indicator hidden" id="castIndicator">
            <i class="fas fa-chromecast"></i>
            <span>Casting to device...</span>
        </div>
        <!-- Accessibility Mode Indicator -->
        <div class="accessibility-indicator hidden" id="accessibilityIndicator">
            <i class="fas fa-universal-access"></i>
            <span>Accessibility mode enabled</span>
        </div>
        <!-- Theme Indicator -->
        <div class="theme-indicator hidden" id="themeIndicator">
            <i class="fas fa-moon"></i>
            <span>Dark theme</span>
        </div>
    
    <!-- JavaScript Modules -->
    <script src="{{ url_for('static', filename='js/ui.js') }}"></script>
    <script src="{{ url_for('static', filename='js/api.js') }}"></script>
    <script src="{{ url_for('static', filename='js/player.js') }}"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <!-- Initialize Player -->
    <script>
        window.addEventListener('load', () => {
            Player.init();
            
            // Initialize indicators
            if (Player.castEnabled) {
                document.getElementById('castIndicator').classList.add('show');
            }
            if (Player.accessibilityMode) {
                document.getElementById('accessibilityIndicator').classList.add('show');
            }
            if (Player.darkTheme) {
                document.getElementById('themeIndicator').classList.add('show');
            }
        });
    </script>
    
    <!-- Mobile Helper Functions -->
    <script>
        // Sidebar toggle for mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('open');
            document.body.classList.toggle('sidebar-open');
        }
        
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('open');
            document.body.classList.remove('sidebar-open');
        }
        
        // Update mobile nav active state
        function updateMobileNav(viewName) {
            const items = document.querySelectorAll('.mobile-nav__item');
            items.forEach(item => item.classList.remove('active'));
            
            const viewMap = {
                'download': 0,
                'library': 1,
                'queue': 2,
                'playlist-downloads': 2
            };
            
            if (viewMap[viewName] !== undefined) {
                items[viewMap[viewName]]?.classList.add('active');
            }
        }
        
        // Sleep timer modal
        function showSleepTimerMenu() {
            document.getElementById('sleepTimerModal').classList.remove('hidden');
        }
        
        function closeSleepTimerMenu() {
            document.getElementById('sleepTimerModal').classList.add('hidden');
        }
        
        function closeSleepTimerModal(event) {
            if (event.target.id === 'sleepTimerModal') {
                closeSleepTimerMenu();
            }
        }
        
        function setSleepTimer(minutes) {
            Player.setSleepTimer(minutes);
            closeSleepTimerMenu();
        }
        
        // Close settings on overlay click
        function closeSettingsOnOverlay(event) {
            if (event.target.id === 'settingsModal') {
                closeSettings();
            }
        }
        
        // Library view toggle
        let libraryViewMode = 'grid';
        function toggleLibraryView() {
            const grid = document.getElementById('libraryGrid');
            const icon = document.getElementById('libraryViewIcon');
            
            if (libraryViewMode === 'grid') {
                libraryViewMode = 'list';
                grid.classList.add('library-grid--list');
                icon.className = 'fas fa-list';
            } else {
                libraryViewMode = 'grid';
                grid.classList.remove('library-grid--list');
                icon.className = 'fas fa-th';
            }
        }
        
        // Library search filter
        function filterLibrary(query) {
            const items = document.querySelectorAll('.library-item');
            const lowerQuery = query.toLowerCase();
            
            items.forEach(item => {
                const title = item.dataset.title?.toLowerCase() || '';
                const artist = item.dataset.artist?.toLowerCase() || '';
                
                if (title.includes(lowerQuery) || artist.includes(lowerQuery)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // Offline detection UI
        window.addEventListener('online', () => {
            document.getElementById('offlineBanner').style.display = 'none';
        });
        
        window.addEventListener('offline', () => {
            document.getElementById('offlineBanner').style.display = 'flex';
        });
        
        // Check initial state
        if (!navigator.onLine) {
            document.getElementById('offlineBanner').style.display = 'flex';
        }
        
        // Prevent zoom on double tap for iOS (but allow interactive elements)
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (event) => {
            // Skip for interactive elements to avoid breaking button/input behavior
            if (event.target.closest('input, textarea, button, a, select, [onclick]')) {
                return;
            }
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, { passive: false });
        
        // Handle safe area insets for notched devices
        function updateSafeAreas() {
            const root = document.documentElement;
            root.style.setProperty('--safe-area-top', 'env(safe-area-inset-top)');
            root.style.setProperty('--safe-area-bottom', 'env(safe-area-inset-bottom)');
            root.style.setProperty('--safe-area-left', 'env(safe-area-inset-left)');
            root.style.setProperty('--safe-area-right', 'env(safe-area-inset-right)');
        }
        updateSafeAreas();
        
        // Sync queue badge with mobile nav
        const originalShowView = window.showView;
        window.showView = function(viewName) {
            if (originalShowView) originalShowView(viewName);
            updateMobileNav(viewName);
        };
    </script>
</body>
</html>
